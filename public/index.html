<Html>
   <form id="form" action="/upload" method="post" enctype="multipart/form-data">
      <input type="file" id="upload"><label id="upload_status"></label>
   </form>
   <div>
      <button onclick="Clean()">Clean</button>
   </div>
   <div>
      <button onclick="UnPack()">Unpack</button>
   </div>
   <div>
      <button onclick="GetName()">Get Name</button>
   </div>
   <div>
      <button onclick="Replace()">Replace</button>
   </div>
   <div>
      <button onclick="RePack()">Repack</button>
   </div>
   <br/>
   <div>
      <button onclick="All()">All</button>
   </div>
</Html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/javascript-canvas-to-blob/3.4.0/js/canvas-to-blob.min.js"></script>

<script>
   var apkname = null;   
   const trade3Option = {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
   }

   function sendFormData(name, data, fn) {
      const formData = new FormData();

      formData.append("name", name);
      
      // HTML file input, chosen by user
      //formData.append("userfile", fileInputElement.files[0]);
      
      // JavaScript file-like object
      //const content = '<q id="a"><span id="b">hey!</span></q>'; // the body of the new fileâ€¦
      //const blob = new Blob([JSON.stringify(data)], { type: "text/json"});
      var blob = window.dataURLtoBlob(data);
      formData.append("file", blob);
      
      const request = new XMLHttpRequest();
      //request.open("POST", "http://localhost:3000/upload");
      request.open("POST", "./upload");
      request.send(formData);
      request.onreadystatechange = (event) => { // Call a function when the state changes.
         if (request.readyState === XMLHttpRequest.DONE && request.status === 200) {
            // Request finished. Do processing here.
         } else {

         }
         console.log("onreadystatechange", event);
      }
      request.onload = () => {
      // Request finished. Do processing here.
         console.log("onload", event);
         if (fn) fn();
      };
      request.onprogress = (event) => { 
         console.log("onprogress", event);
         const elm = document.getElementById("upload_status");

         if (elm) elm.innerHTML = 100 * event.loaded / event.total;
      }
   }
   async function All() {
      var data = null;
      var mem  = {};

      data = await Clean(mem);   
      console.log("[Clean]", data);
      data = await UnPack(mem);  
      console.log("[UnPack]", data);
      data = await GetName(mem); 
      console.log("[GetName]", data);
      mem.search = data;
      data = await Replace(mem); 
      console.log("[Replace]", data);
      data = await RePack(mem);
      console.log("[RePack]", data);
   }
   async function UnPack(mem, log=false) {
      const params   = JSON.stringify( { apkname:apkname } )
      const options  = Object.assign({body: params},trade3Option);
      const res      = await fetch('/unpack', options);
      const data     = await res.json();

      if (log) console.log("[UnPack]", data);
      return data;
   }
   async function RePack(mem, log=false) {
      const params   = JSON.stringify( { apkname:apkname } )
      const options  = Object.assign({body: params},trade3Option);
      const res      = await fetch('/repack', options);
      const data     = await res.json();

      if (log) console.log("[RePack]", data);
      return data;
   }
   async function Clean(mem, log=false) {
      const params   = JSON.stringify( { apkname:apkname } )
      const options  = Object.assign({body: params},trade3Option);
      const res      = await fetch('/clean', options);
      const data     = await res.json();

      if (log) console.log("[Clean]", data);
      return data;
   }
   async function GetName(mem, log=false) {
      const params   = JSON.stringify( { apkname:apkname } )
      const options  = Object.assign({body: params},trade3Option);
      const res      = await fetch('/getname', options);
      const data     = await res.json();

      if (log) console.log("[GetName]", data);
      return data;
   }
   async function Replace(mem, log=false) {
      const params   = JSON.stringify( { apkname:apkname } )
      const options  = Object.assign({body: params},trade3Option);
      const res      = await fetch('/replace', options);
      const data     = await res.json();

      if (log) console.log("[Replace]", data);
      return data;
   }
   document.getElementById("upload").onchange = function() {
      var file = document.getElementById("upload").files[0];
      var reader = new FileReader();
      reader.onload = function() {
         sendFormData(file.name, reader.result)
         apkname = file.name;
      };
      reader.readAsDataURL(file);
   }
</script>
